<!doctype html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SAFT Doctor ‚Ä¢ Validador</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet">

    <!-- Custom CSS para ajustes espec√≠ficos -->
    <style>
        :root {
            --tblr-primary: #2563eb;
            --tblr-primary-rgb: 37, 99, 235;
        }

        /* Ajustes para manter comportamento existente */
        .navbar-brand-image {
            height: 2rem;
            width: auto;
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1050;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
        }

        .log-line {
            padding: 0.25rem 0.5rem;
            border-bottom: 1px solid var(--tblr-border-color);
        }

        .tabpanel {
            display: none;
        }

        .tabpanel.active {
            display: block;
        }

        /* Login overlay customizado */
        .login-overlay-custom {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .help-widget {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1040;
        }

        .help-widget-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    </style>

    <script src="/static/app.js?v=51"></script>
</head>
<body>
    <!-- Navbar -->
    <header class="navbar navbar-expand-md navbar-dark d-print-none sticky-top" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);">
        <div class="container-xl">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                <a href=".">
                    <span class="navbar-brand-image">üìã</span>
                    SAFT Doctor
                </a>
            </h1>
            <div class="navbar-nav flex-row order-md-last">
                <div class="nav-item d-none d-md-flex me-3">
                    <div class="btn-list">
                        <span id="navbar-username" class="text-white-50">N√£o autenticado</span>
                    </div>
                </div>
                <button class="btn btn-outline-light me-2" id="btn-profile" onclick="showProfileModal()" style="display: none;">
                    <i class="ti ti-settings"></i> Perfil
                </button>
                <button class="btn btn-outline-light" id="btn-logout" onclick="logout()" style="display: none;">
                    <i class="ti ti-logout"></i> Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Page wrapper -->
    <div class="page">
        <!-- Navigation tabs -->
        <div class="page-header d-print-none">
            <div class="container-xl">
                <div class="row g-2 align-items-center">
                    <div class="col">
                        <div class="page-pretitle">Validador profissional de ficheiros SAFT-T (PT)</div>
                        <h2 class="page-title">Dashboard</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="page-body">
            <div class="container-xl">
                <ul class="nav nav-tabs mb-4" data-bs-toggle="tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a href="#tab-app" class="nav-link active" data-bs-toggle="tab" aria-selected="true" role="tab" id="app-tab" data-tab="app" onclick="showTab('app')">
                            <i class="ti ti-upload"></i> Valida√ß√£o
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a href="#tab-docs" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1" id="docs-tab" data-tab="docs" onclick="showTab('docs')">
                            <i class="ti ti-file-text"></i> Documentos
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a href="#tab-history" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1" id="history-tab" data-tab="history" onclick="showTab('history')">
                            <i class="ti ti-history"></i> Hist√≥rico
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a href="#tab-creds" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1" id="creds-tab" data-tab="creds" onclick="showTab('creds')">
                            <i class="ti ti-key"></i> Credenciais
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a href="#tab-config" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1" id="config-tab" data-tab="config" onclick="showTab('config')">
                            <i class="ti ti-settings"></i> Configura√ß√£o
                        </a>
                    </li>
                    <li class="nav-item" role="presentation" id="admin-tab-li" style="display: none;">
                        <a href="#tab-admin" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1" id="admin-tab" data-tab="admin" onclick="showTab('admin')">
                            <i class="ti ti-crown"></i> Admin
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- TAB: Valida√ß√£o -->
                    <div class="tab-pane active show" id="tab-app" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="ti ti-upload me-2"></i>Validar ficheiro SAFT</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label required">Escolha um ficheiro XML</label>
                                    <input type="file" class="form-control" id="file" accept=".xml,text/xml" onchange="onFileChange(event)">
                                    <small class="form-hint">Formatos aceites: .xml (SAFT-T PT)</small>
                                </div>
                                <div class="btn-list">
                                    <button class="btn btn-primary" onclick="validateFile()">
                                        <i class="ti ti-check me-2"></i>Validar
                                    </button>
                                    <button class="btn btn-success" onclick="submitToAT()" id="btn-submit" style="display: none;">
                                        <i class="ti ti-send me-2"></i>Enviar para AT
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="exportReport()" id="btn-export" style="display: none;">
                                        <i class="ti ti-download me-2"></i>Exportar Relat√≥rio
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Resultados da Valida√ß√£o -->
                        <div id="validation-results" style="display: none;" class="mt-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="ti ti-file-analytics me-2"></i>Resultados da Valida√ß√£o</h3>
                                </div>
                                <div class="card-body">
                                    <div id="results-content"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Log Console -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h3 class="card-title"><i class="ti ti-terminal me-2"></i>Log Console</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                                        <i class="ti ti-trash"></i> Limpar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="log-container" id="log"></div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Documentos -->
                    <div class="tab-pane" id="tab-docs" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="ti ti-file-text me-2"></i>Documentos no Ficheiro SAFT</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-primary" onclick="exportDocsToCSV()">
                                        <i class="ti ti-download me-2"></i>Exportar CSV
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="exportDocsToExcel()">
                                        <i class="ti ti-file-spreadsheet me-2"></i>Exportar Excel
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="docs-table-container"></div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Hist√≥rico -->
                    <div class="tab-pane" id="tab-history" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="ti ti-history me-2"></i>Hist√≥rico de Valida√ß√µes</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-primary" onclick="loadHistory()">
                                        <i class="ti ti-refresh"></i> Atualizar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="history-loading" class="text-center py-5" style="display: none;">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2 text-muted">A carregar hist√≥rico...</p>
                                </div>
                                <div id="history-empty" class="empty" style="display: none;">
                                    <p class="empty-title">Sem hist√≥rico</p>
                                    <p class="empty-subtitle text-muted">Ainda n√£o foram realizadas valida√ß√µes.</p>
                                </div>
                                <div id="history-results"></div>
                                <div id="history-error" class="alert alert-danger" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Credenciais -->
                    <div class="tab-pane" id="tab-creds" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="ti ti-key me-2"></i>Gest√£o de credenciais AT</h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="ti ti-info-circle me-2"></i>
                                    As credenciais s√£o guardadas <strong>encriptadas</strong> no servidor e associadas ao seu utilizador.
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Username AT</label>
                                    <input type="text" class="form-control" id="at_user" placeholder="username">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Password AT</label>
                                    <input type="password" class="form-control" id="at_pass" placeholder="password">
                                </div>
                                <div class="btn-list">
                                    <button class="btn btn-primary" onclick="saveATCreds()">
                                        <i class="ti ti-device-floppy me-2"></i>Guardar
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="loadATCreds()">
                                        <i class="ti ti-refresh me-2"></i>Carregar
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteATCreds()">
                                        <i class="ti ti-trash me-2"></i>Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Configura√ß√£o -->
                    <div class="tab-pane" id="tab-config" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="ti ti-settings me-2"></i>Instalar FACTEMICLI.jar</h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="ti ti-info-circle me-2"></i>
                                    Configure o acesso ao ficheiro FACTEMICLI.jar oficial da Autoridade Tribut√°ria.
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Escolha o ficheiro FACTEMICLI.jar</label>
                                    <input type="file" class="form-control" id="jar_file" accept=".jar">
                                </div>
                                <button class="btn btn-primary" onclick="uploadJar()">
                                    <i class="ti ti-upload me-2"></i>Instalar JAR
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Admin (Sysadmin only) -->
                    <div class="tab-pane" id="tab-admin" role="tabpanel" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="ti ti-crown me-2"></i>Painel de Administra√ß√£o (Sysadmin)</h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <i class="ti ti-alert-triangle me-2"></i>
                                    Configura√ß√£o de sistema acess√≠vel apenas para administradores.
                                </div>

                                <h4 class="mb-3"><i class="ti ti-mail me-2"></i>Configura√ß√£o SMTP (ServerSMTP.com)</h4>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label required">SMTP Host</label>
                                        <input type="text" class="form-control" id="smtp-host" placeholder="mail.serversmtp.com">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label required">SMTP Port</label>
                                        <input type="number" class="form-control" id="smtp-port" placeholder="587" value="587">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label required">SMTP User</label>
                                        <input type="text" class="form-control" id="smtp-user" placeholder="username">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label required">SMTP Password</label>
                                        <input type="password" class="form-control" id="smtp-password" placeholder="password">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label required">From Email</label>
                                        <input type="email" class="form-control" id="smtp-from-email" placeholder="noreply@saft.aquinos.io">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">From Name</label>
                                        <input type="text" class="form-control" id="smtp-from-name" placeholder="SAFT Doctor" value="SAFT Doctor">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label required">URL da Aplica√ß√£o ‚ö†Ô∏è (Obrigat√≥rio para links de reset)</label>
                                        <input type="url" class="form-control" id="smtp-app-url" placeholder="https://saft.aquinos.io" value="https://saft.aquinos.io">
                                        <small class="form-hint">URL completo onde a aplica√ß√£o est√° hospedada (usado nos links de recupera√ß√£o de password)</small>
                                    </div>
                                </div>

                                <div class="btn-list mt-4">
                                    <button class="btn btn-primary" onclick="saveSmtpConfig()">
                                        <i class="ti ti-device-floppy me-2"></i>Guardar
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="loadSmtpConfig()">
                                        <i class="ti ti-refresh me-2"></i>Carregar Config
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteSmtpConfig()">
                                        <i class="ti ti-trash me-2"></i>Eliminar
                                    </button>
                                </div>

                                <div id="smtp-config-source" class="alert alert-info mt-3" style="display: none;">
                                    <i class="ti ti-info-circle me-2"></i>
                                    Fonte: <strong id="smtp-source-text"></strong>
                                </div>

                                <!-- Test SMTP -->
                                <hr class="my-4">
                                <h4 class="mb-3"><i class="ti ti-mail-forward me-2"></i>Testar Configura√ß√£o SMTP</h4>
                                <p class="text-muted">Envie um email de teste para verificar se a configura√ß√£o est√° a funcionar.</p>
                                <div class="mb-3">
                                    <label class="form-label">Email de Teste</label>
                                    <input type="email" class="form-control" id="smtp-test-email" placeholder="seu@email.com">
                                </div>
                                <button class="btn btn-success" onclick="testSmtpConfig()">
                                    <i class="ti ti-send me-2"></i>Enviar Email de Teste
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar (fixed bottom) -->
    <div class="status-bar">
        <div id="status" class="alert mb-0 rounded-0" style="display: none;"></div>
    </div>

    <!-- Login Overlay (ser√° usado com Tabler Modal) -->
    <div class="login-overlay-custom" id="login-overlay" style="display: flex;">
        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üîê Autentica√ß√£o</h5>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" data-bs-toggle="tabs">
                        <li class="nav-item">
                            <a href="#tabs-login" class="nav-link active" id="login-tab-btn" data-bs-toggle="tab" onclick="showAuthTab('login')">Login</a>
                        </li>
                        <li class="nav-item">
                            <a href="#tabs-register" class="nav-link" id="register-tab-btn" data-bs-toggle="tab" onclick="showAuthTab('register')">Registar</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <!-- Login Form -->
                        <div class="tab-pane active show" id="tabs-login">
                            <div id="login-form">
                                <div class="mb-3">
                                    <label class="form-label required">Username</label>
                                    <input type="text" class="form-control" id="login_user" placeholder="username">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Password</label>
                                    <input type="password" class="form-control" id="login_pass" placeholder="password">
                                </div>
                                <div class="btn-list">
                                    <button class="btn btn-primary w-100" onclick="doLogin()">
                                        <i class="ti ti-login me-2"></i>Entrar
                                    </button>
                                </div>
                                <div class="text-center mt-3">
                                    <a href="#" class="link-secondary" onclick="showAuthTab('password-reset'); return false;">
                                        Esqueci a password
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Register Form -->
                        <div class="tab-pane" id="tabs-register">
                            <div id="register-form">
                                <div class="mb-3">
                                    <label class="form-label required">Username</label>
                                    <input type="text" class="form-control" id="register_user" placeholder="username">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email (opcional)</label>
                                    <input type="email" class="form-control" id="register_email" placeholder="seu@email.com">
                                    <small class="form-hint">Necess√°rio para recupera√ß√£o de password</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Password</label>
                                    <input type="password" class="form-control" id="register_pass" placeholder="password">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label required">Confirmar Password</label>
                                    <input type="password" class="form-control" id="register_pass_confirm" placeholder="confirme a password">
                                </div>
                                <button class="btn btn-primary w-100" onclick="doRegister()">
                                    <i class="ti ti-user-plus me-2"></i>Criar Conta
                                </button>
                                <div class="text-center mt-2">
                                    <small class="text-muted">Ap√≥s registar, fa√ßa login com as suas credenciais</small>
                                </div>
                            </div>
                        </div>

                        <!-- Password Reset Request Form (hidden initially) -->
                        <div id="password-reset-form" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" id="reset_username" placeholder="username">
                            </div>
                            <div class="btn-list">
                                <button class="btn btn-primary" onclick="requestPasswordReset()">
                                    <i class="ti ti-mail me-2"></i>Enviar Email
                                </button>
                                <button class="btn btn-outline-secondary" onclick="showAuthTab('login')">Voltar</button>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">Receber√° um email com instru√ß√µes para recuperar a password</small>
                            </div>
                        </div>

                        <!-- New Password Form (shown when URL has reset_token) -->
                        <div id="new-password-form" style="display: none;">
                            <h5 class="mb-3 text-primary">Criar Nova Password</h5>
                            <div class="mb-3">
                                <label class="form-label">Nova Password</label>
                                <input type="password" class="form-control" id="new_password" placeholder="nova password">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Confirmar Password</label>
                                <input type="password" class="form-control" id="new_password_confirm" placeholder="confirme a nova password">
                            </div>
                            <button class="btn btn-primary w-100" onclick="confirmPasswordReset()">
                                <i class="ti ti-check me-2"></i>Guardar Password
                            </button>
                            <div class="text-center mt-2">
                                <small class="text-muted">Ap√≥s guardar, poder√° fazer login com a nova password</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="login-overlay-custom" id="profile-overlay" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="ti ti-user me-2"></i>Perfil de Utilizador</h5>
                    <button type="button" class="btn-close" onclick="closeProfileModal()"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="profile-username" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="profile-email" placeholder="seu@email.com">
                        <small class="form-hint">Necess√°rio para recupera√ß√£o de password</small>
                    </div>
                    <button class="btn btn-primary" onclick="updateProfileEmail()">
                        <i class="ti ti-device-floppy me-2"></i>Guardar Email
                    </button>

                    <!-- Change Password Section -->
                    <hr class="my-4">
                    <h5 class="mb-3"><i class="ti ti-lock me-2"></i>Alterar Password</h5>
                    <div class="mb-3">
                        <label class="form-label">Password Atual</label>
                        <input type="password" class="form-control" id="profile-current-password" placeholder="password atual">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nova Password</label>
                        <input type="password" class="form-control" id="profile-new-password" placeholder="nova password">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirmar Nova Password</label>
                        <input type="password" class="form-control" id="profile-new-password-confirm" placeholder="confirme a nova password">
                    </div>
                    <button class="btn btn-warning" onclick="changePasswordFromProfile()">
                        <i class="ti ti-key me-2"></i>Alterar Password
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Widget -->
    <div class="help-widget">
        <button class="btn btn-primary help-widget-button" onclick="toggleHelpWidget()">
            <i class="ti ti-help" style="font-size: 1.5rem;"></i>
        </button>
    </div>

    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
</body>
</html>
